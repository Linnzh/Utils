## 代理模式 - Proxy

概念：为其他对象提供一种代理，以控制对这个对象的访问。

别名**Surrogate**。其核心思想是：

- 使用一个额外的间接层来支持分散的、可控的、智能的访问
- 增加一个包装和委托来保护真实的组件，以避免过度复杂

代理对象可以在客户端和目标对象之间起到中间调和的作用，并且通过代理对象隐藏不希望被客户端看到的内容和服务，或添加客户需要的额外服务。

![代理模式的解决方案](assets/设计模式/solution-zh-16471134700245.png)

代理模式建议新建一个与原服务对象接口相同的代理类，然后更新应用以将代理对象传递给所有原始对象客户端。代理类接收到客户端请求后会创建实际的服务对象，并将所有工作委派给它。

### 适用性

- 远程代理（Remote Proxy）：本地执行远程服务，为一个对象在不同地址空间提供局部代表，类似“大使”。
- 虚拟代理（Virtual Proxy）：延迟初始化，根据需要创建开销很大的对象。
- 保护代理（Protection Proxy）：控制对原始对象的访问，用于对象应该有不同访问权限时。
- 智能引用（Smart Reference）：在访问对象时执行一些附加操作，典型用途包括：
    - 对指向实际对象的引用计数，当该对象没有引用时，可以自动释放它
    - 当第一次引用一个持久对象时，将其装入内存
    - 在访问一个实际对象前，检查是否已经锁定它，以确保其他对象不能改变它
- 缓存请求结果：适用于需要缓存客户请求结果并对缓存生命周期进行管理时，特别是当返回结果的体积非常大时。

### 特点

- 尽管代理模式在绝大多数 PHP 程序中并不常见，但它在一些特殊情况下仍然非常方便。当你希望在无需修改客户代码的前提下于已有类的对象上增加额外行为时，该模式是无可替代的。

### 参与者

- Proxy（代理）
    - 保存一个引用使得代理可以访问实体。如果 RealSubject 和 Subject 的接口相同，Proxy 将会引用 Subject。
    - 提供一个与 Subject 的接口相同的接口，这样代理就可以用来替代实体。
    - 控制对实体的存取，并可能负责创建和删除它。
- Subject（实体接口）
    - 定义 RealSubject 和 Proxy 的共用接口，这样就在任何使用 RealSubject 的地方都可以使用 Proxy
- RealSubject（实体）
    - 定义 Proxy 所代表的实体。

### 案例

- 火车票和机票的代售点。
- 信用卡是银行账户的代理，银行账户则是一大捆现金的代理。它们都实现了同样的接口，均可用于进行支付。
- HTML 的占位符。
- 各类特殊用途的代理：远程代理、虚拟代理、防火墙代理、同步化（Synchronization）代理、智能引用（Smart Reference）代理等。

### 对现有业务的思考

很明显该模式适用于缓存。这里可以模拟一个存入缓存、缓存命中、缓存失效的过程。

```php
public function testExample(): void
{
    $url = 'http://www.baidu.com';
    $realSubject = new Downloader();
    $realResult = $realSubject->download($url);

    $proxySubject = new CachingDownloader();
    $proxyResult = $realSubject->download($url);

    $this->assertEquals($realResult, $proxyResult);
}
```

